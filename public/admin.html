<!DOCTYPE html>
<html>
<head>
<title>Admin Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#0c0c0c; color:#00eaff; font-family: monospace; padding:10px; }
h2 { color:#4dfcff; }
button{
 background:#00eaff; border:none; color:#000; padding:10px;
 border-radius:5px; cursor:pointer; font-weight:bold; margin:6px;
}
.container{ width:95%; margin:auto; }

.block{
 border:1px solid #00eaff;
 padding:15px; margin:15px 0; border-radius:10px;
 background:rgba(255,255,255,0.06);
}

.hash-link{
 color:#5bff84; cursor:pointer; text-decoration:underline;
}

#popup{
 position:fixed; top:0; left:0; width:100%; height:100%;
 background:rgba(0,0,0,0.9);
 display:none; justify-content:center; align-items:center;
}
#popup img{
 max-width:90%;
 border:2px solid #00eaff; border-radius:10px;
}

.log-box{
 background:rgba(255,255,255,0.08);
 border-radius:10px; padding:10px;
 max-height:200px; overflow-y:auto;
 border:1px solid #00eaff;
}
</style>
</head>
<body>

<div class="container">
<h2>ğŸ›¡ ADMIN PANEL</h2>

<button onclick="validate()">Validate Blockchain</button>
<button onclick="logout()">Logout</button>

<hr>

<h3>ğŸ“Œ Blockchain Records</h3>
<div id="chain">Loading...</div>

<hr>

<h3>ğŸ“¦ Restore Requests</h3>
<div id="requests">Loading...</div>

<hr>

<h3>ğŸ“œ Activity Logs</h3>
<div id="logs" class="log-box">Loading...</div>

</div>

<div id="popup" onclick="this.style.display='none'">
 <img id="imgPreview">
</div>

<script>
const API = "https://block-chain-0xps.onrender.com";
const token = localStorage.getItem("token");
if(!token) location.href="login.html";

// ---- LOAD BLOCKCHAIN ----
async function loadChain(){
 let res = await fetch(API+"/chain/admin",{ headers:{Authorization:token} });
 let data = await res.json();
 let box = document.getElementById("chain");
 box.innerHTML="";

 data.forEach(b=>{
 box.innerHTML+=`
 <div class='block'>
 <b>Block #${b.index}</b><br>
 <small>${b.timestamp}</small><br><br>
 <p><b>Description:</b> ${b.text}</p>
 <p><b>Image Hash:</b> <span class='hash-link' onclick="view('${b.imageId}')">${b.imageHash || "No Image"}</span></p>
 <p><b>Prev Hash:</b> ${b.previousHash}</p>
 <p><b>Curr Hash:</b> ${b.hash}</p>
 ğŸ’  Status: <b>${b.status}</b><br><br>
 <button onclick="freeze(${b.index})">Freeze</button>
 <button onclick="invalidate(${b.index})">Invalidate</button>
 </div>`;
 });
}

// ---- VIEW IMAGE ----
function view(id){
 if(!id) return alert("No Image");
 document.getElementById("imgPreview").src = `${API}/reveal/${id}?auth=${token}`;
 document.getElementById("popup").style.display="flex";
}

// ---- FREEZE ----
async function freeze(i){
 await fetch(API+"/freeze/"+i,{method:"POST",headers:{Authorization:token}});
 loadChain();
}

// ---- INVALIDATE ----
async function invalidate(i){
 await fetch(API+"/invalidate/"+i,{method:"POST",headers:{Authorization:token}});
 loadChain();
}

// ---- VALIDATE ----
async function validate(){
 let res = await fetch(API+"/validate",{headers:{Authorization:token}});
 let data = await res.json();
 if(data.valid) alert("âœ” Blockchain Valid - No Tampering");
 else alert("âŒ ERROR: "+data.issue);
}

// ---- RESTORE REQUESTS ----
async function loadRequests(){
 let res = await fetch(API+"/restore/requests",{headers:{Authorization:token}});
 let r = await res.json();
 let box = document.getElementById("requests");
 box.innerHTML="";
 r.forEach(v=>{
 box.innerHTML+=`
 <div class="block">
 <b>User:</b> ${v.user}<br>
 <b>Block:</b> ${v.blockIndex}<br>
 <b>Reason:</b> ${v.reason}<br>
 <b>Status:</b> ${v.status}<br><br>
 ${v.status=="pending"?`
 <button onclick="approve('${v._id}')">Approve</button>
 <button onclick="reject('${v._id}')">Reject</button>
 `:""}
 </div>
 `;
 });
}

async function approve(id){
 await fetch(API+"/restore/approve/"+id,{method:"POST",headers:{Authorization:token}});
 loadChain(); loadRequests();
}
async function reject(id){
 await fetch(API+"/restore/reject/"+id,{method:"POST",headers:{Authorization:token}});
 loadRequests();
}

// ---- ACTIVITY LOGS ----
async function loadLogs(){
 let res = await fetch(API+"/logs",{headers:{Authorization:token}});
 let log = await res.json();
 let box=document.getElementById("logs");
 box.innerHTML="";
 log.forEach(l=>{
 box.innerHTML+= `<div>ğŸ“ ${l.message} â€” <small>${l.time}</small></div>`;
 });
}

// ---- LOGOUT ----
async function logout(){
 await fetch(API+"/activity/logout",{method:"POST",headers:{Authorization:token}});
 localStorage.clear();
 location.href="login.html";
}

// Auto refresh
setInterval(()=>{ loadChain(); loadRequests(); loadLogs(); },3000);

loadChain();
loadRequests();
loadLogs();
</script>

</body>
</html>
