<!DOCTYPE html>
<html>
<head>
<title>Admin Panel - Evidence Blockchain</title>
<style>
body { background:#0a0a0a; color:#00eaff; font-family: monospace; }
.container { width:90%; margin:auto; }
.block {
  background:rgba(255,255,255,0.05);
  padding:15px;
  margin:15px 0;
  border:1px solid #00eaff;
  border-radius:10px;
}
.hash-link {
  color:#5bff84;
  cursor:pointer;
  text-decoration:underline;
}
button {
  background:#00eaff; border:none; padding:8px 14px; cursor:pointer;
  border-radius:6px; margin-right:5px; font-weight:bold;
}
#popup {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85); display:flex; align-items:center;
  justify-content:center; display:none;
}
#popup img { max-width:90%; border:3px solid #00eaff; border-radius:10px; }
</style>
</head>
<body>

<div class="container">
<h2>ðŸ›¡ ADMIN CONTROL PANEL</h2>
<button onclick="logout()">Logout</button>
<hr>

<h3>Blockchain Records</h3>
<div id="chain"></div>

<h3>Restore Requests</h3>
<div id="requests"></div>
</div>

<div id="popup" onclick="this.style.display='none'">
  <img id="previewImg">
</div>

<script>
const API = "https://block-chain-0xps.onrender.com";
const token = localStorage.getItem("token");

if(!token) location.href="login.html";

// Fetch Blockchain
async function loadChain(){
  const res = await fetch(API+"/chain/admin",{ headers:{Authorization:token} });
  const data = await res.json();
  const box = document.getElementById("chain");
  box.innerHTML="";

  data.forEach(b=>{
    box.innerHTML += `
      <div class='block'>
      <p><b>Block #${b.index}</b></p>
      <p><b>Timestamp:</b> ${b.timestamp}</p>
      <p><b>Description:</b> ${b.text}</p>
      <p><b>Image Hash:</b> <span class='hash-link' onclick="viewImage('${b.imageId}')">${b.imageHash || "No Image"}</span></p>
      <p><b>Previous Hash:</b> ${b.previousHash}</p>
      <p><b>Current Hash:</b> ${b.hash}</p>
      <button onclick="freeze(${b.index})">Freeze</button>
      <button onclick="invalidate(${b.index})">Invalidate</button>
      </div>
    `;
  });
}

// Show image popup
async function viewImage(id){
  if(id=="") return alert("No Image Available");

  const img=document.getElementById("previewImg");
  img.src=API+"/reveal/"+id+"?auth="+token;
  document.getElementById("popup").style.display="flex";
}

// Freeze / Invalidate
async function freeze(i){
  await fetch(API+"/freeze/"+i,{method:"POST",headers:{Authorization:token}});
  loadChain();
}
async function invalidate(i){
  await fetch(API+"/invalidate/"+i,{method:"POST",headers:{Authorization:token}});
  loadChain();
}

// Restore Requests
async function loadRequests(){
  const res = await fetch(API+"/restore/requests",{ headers:{Authorization:token} });
  const r = await res.json();
  const box = document.getElementById("requests");
  box.innerHTML="";

  r.forEach(x=>{
    box.innerHTML += `
    <div class="block">
    <p><b>Request By:</b> ${x.user}</p>
    <p><b>Block:</b> #${x.blockIndex}</p>
    <p><b>Reason:</b> ${x.reason}</p>
    <p><b>Status:</b> ${x.status}</p>
    ${x.status=="pending" ? `
      <button onclick="approve('${x._id}')">Approve</button>
      <button onclick="reject('${x._id}')">Reject</button>
    `:""}
    </div>
    `;
  });
}

async function approve(id){
  await fetch(API+"/restore/approve/"+id,{method:"POST",headers:{Authorization:token}});
  loadRequests(); loadChain();
}
async function reject(id){
  await fetch(API+"/restore/reject/"+id,{method:"POST",headers:{Authorization:token}});
  loadRequests();
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}

loadChain();
loadRequests();
</script>
</body>
</html>
