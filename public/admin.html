<!DOCTYPE html>
<html>
<head>
<title>Admin Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #0e0e0e;
    color: white;
    font-family: Arial;
    margin: 0;
}

h2 {
    text-align: center;
    margin-top: 15px;
    color: #00f0ff;
}

.container {
    width: 92%;
    margin: auto;
}

.card {
    background: #1c1c1c;
    padding: 15px;
    border-radius: 10px;
    border-left: 4px solid #00f0ff;
    margin-top: 18px;
}

button {
    background: #00f0ff;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
    font-weight: bold;
}
button:hover {
    background: cyan;
}

.block {
    background: #121212;
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 3px solid #00f0ff;
}

.hash {
    color: #00ffc8;
    cursor: pointer;
    display: inline-block;
    text-decoration: underline;
}

.status {
    padding: 5px 8px;
    border-radius: 5px;
    background: #444;
    display: inline-block;
    font-size: 12px;
}

#modal {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    background: rgba(0,0,0,0.85);
    justify-content:center;
    align-items:center;
}
#modal img {
    max-width:80%;
    border:4px solid white;
    border-radius:10px;
}
</style>
</head>

<body>

<h2>‚öñ Admin Evidence Blockchain System</h2>

<div class="container">

    <button onclick="loadBlocks()">üîÑ Refresh</button>
    <button onclick="validate()">‚úî Validate Chain</button>
    <button onclick="loadRequests()">üì© Restore Requests</button>
    <button onclick="loadLogs()">üìú Logs</button>
    <button onclick="logout()" style="background:#ff4a4a; color:white;">Logout</button>

    <div id="output"></div>

</div>

<!-- IMAGE VIEW MODAL -->
<div id="modal" onclick="document.getElementById('modal').style.display='none'">
    <img id="modalImg" src="">
</div>


<script>
const API = "https://block-chain-0xps.onrender.com";
const token = localStorage.getItem("token");

if(!token) window.location.href = "login.html";

async function loadBlocks(){
    let res = await fetch(`${API}/chain/admin`,{
        headers:{ "Authorization":token }
    });

    let data = await res.json();
    let out = document.getElementById("output");
    out.innerHTML = "<h3>üì¶ Blockchain Records</h3>";

    data.forEach(b=>{
        out.innerHTML += `
        <div class="block">
            <b>Block #${b.index}</b><br>
            <small>${new Date(b.timestamp).toLocaleString()}</small><br><br>
            
            <p><b>Description:</b> ${b.text}</p>
            <p><b>Hash:</b> <span class="hash" onclick="viewImage('${b.imageId}', '${b.imageHash}')">${b.imageHash || "No Image"}</span></p>
            <p><b>Status:</b> <span class="status">${b.status}</span></p>

            <button onclick="freeze(${b.index})">Freeze</button>
            <button onclick="invalidate(${b.index})">Invalidate</button>
        </div>
        `;
    });
}

async function viewImage(id, hash){
    if(!id) return alert("No image attached.");

    document.getElementById("modal").style.display="flex";
    document.getElementById("modalImg").src = `${API}/reveal/${id}?auth=${token}`;
}

async function freeze(i){
    await fetch(`${API}/freeze/${i}`,{
        method:"POST",
        headers:{ "Authorization":token }
    });
    alert("üßä Block Frozen");
    loadBlocks();
}

async function invalidate(i){
    await fetch(`${API}/invalidate/${i}`,{
        method:"POST",
        headers:{ "Authorization":token }
    });
    alert("‚ö† Block Marked Invalid");
    loadBlocks();
}

async function validate(){
    let res = await fetch(`${API}/validate`,{ headers:{ "Authorization":token }});
    let result = await res.json();
    alert(result.msg);
}

async function loadRequests(){
    let res = await fetch(`${API}/restore/requests`,{
        headers:{ "Authorization":token }
    });

    let data = await res.json();
    let out = document.getElementById("output");
    out.innerHTML = "<h3>üì© Restore Requests</h3>";

    if(data.length === 0){
        out.innerHTML += "<p>No requests yet.</p>";
        return;
    }

    data.forEach(r=>{
        out.innerHTML += `
        <div class="block">
            <p><b>User:</b> ${r.user}</p>
            <p><b>Block:</b> #${r.blockIndex}</p>
            <p><b>Reason:</b> ${r.reason}</p>
            <p><b>Status:</b> ${r.status}</p>
            
            <button onclick="approve('${r._id}')">‚úî Approve</button>
            <button onclick="reject('${r._id}')" style="background:#ff6565">Reject</button>
        </div>`;
    });
}

async function approve(id){
    await fetch(`${API}/restore/approve/${id}`,{ method:"POST", headers:{ "Authorization":token }});
    alert("‚úî Restore Approved - Chain Restored");
    loadRequests();
    loadBlocks();
}

async function reject(id){
    await fetch(`${API}/restore/reject/${id}`,{ method:"POST", headers:{ "Authorization":token }});
    alert("‚ùå Request Rejected");
    loadRequests();
}

async function loadLogs(){
    let res = await fetch(`${API}/logs`,{
        headers:{ "Authorization":token }
    });

    let logs = await res.json();
    let out = document.getElementById("output");
    out.innerHTML = "<h3>üìú User Activity Logs</h3>";

    logs.forEach(l=>{
        out.innerHTML += `
        <div class="block">
            <p><b>User:</b> ${l.user}</p>
            <p><b>Action:</b> ${l.action}</p>
            <p><b>Time:</b> ${new Date(l.time).toLocaleString()}</p>
        </div>`;
    });
}

async function logout(){
    await fetch(`${API}/activity/logout`,{
        method:"POST",
        headers:{ "Authorization":token }
    });
    localStorage.removeItem("token");
    window.location.href = "login.html";
}

loadBlocks();
</script>

</body>
</html>
