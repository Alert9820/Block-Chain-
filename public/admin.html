<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Digital Evidence Blockchain</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #020202;
    color: cyan;
    font-family: monospace;
    margin: 0;
}

header {
    padding: 15px;
    background: rgba(0,255,255,0.1);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid cyan;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

button {
    background: cyan;
    border: none;
    padding: 10px 14px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 8px;
}

#dashboard {
    padding: 20px;
}

.card {
    background: rgba(0,0,0,0.6);
    border: 1px solid cyan;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.block {
    padding: 10px;
    border: 1px solid cyan;
    margin-bottom: 10px;
    border-radius: 8px;
}

img {
    max-width: 100%;
    margin-top: 10px;
    border: 1px solid cyan;
}

.badge {
    display: inline-block;
    padding: 5px 10px;
    background: lime;
    color: black;
    margin-bottom: 10px;
    border-radius: 8px;
    font-weight: bold;
}
.invalid { background: red; }
.frozen { background: yellow; }
.pending { background: orange; }
.approved { background: lime; }
.rejected { background: gray; }

</style>
</head>
<body>

<header>
    <h2>‚ö° ADMIN PANEL</h2>
    <button onclick="logout()">Logout</button>
</header>

<div id="dashboard">

    <div class="card">
        <h3>Blockchain Overview</h3>
        <button onclick="loadChain()">üìÇ Load Blockchain</button>
        <button onclick="validate()">üïµÔ∏è Validate Chain</button>
        <p id="chainStatus"></p>
        <div id="chain"></div>
    </div>

    <div class="card">
        <h3>Restore Approval Requests</h3>
        <button onclick="loadRequests()">üì® Load Requests</button>
        <div id="requests"></div>
    </div>

</div>

<script>
const API = "https://block-chain-0xps.onrender.com";
let token = localStorage.getItem("token");

// Redirect if no token
if (!token) location.href = "login.html";

// ------- Logout -------
function logout() {
  localStorage.clear();
  location.href = "login.html";
}

// ------- Load Blockchain -------
async function loadChain() {
  const res = await fetch(API + "/chain", {
    headers: { "Authorization": token }
  });

  const chain = await res.json();
  const box = document.getElementById("chain");
  box.innerHTML = "";

  chain.forEach(b => {
    box.innerHTML += `
      <div class="block">
        <div class="badge ${b.status}">${b.status.toUpperCase()}</div>

        <p><b>Block #${b.index}</b></p>
        <p><b>Timestamp:</b> ${b.timestamp}</p>
        <p><b>Description:</b> ${b.text}</p>

        <p><b>Hash:</b> ${b.hash}</p>
        <p><b>Previous Hash:</b> ${b.previousHash}</p>
        <p><b>Image Hash:</b> ${b.imageHash || "None"}</p>

        ${b.imageId ? `<img src="${API}/file/${b.imageId}" />` : "<i>No Image</i>"}

        <button onclick="freeze(${b.index})">Freeze</button>
        <button onclick="invalidate(${b.index})">Invalidate</button>
      </div>`;
  });
}

// ------- Freeze Block -------
async function freeze(index) {
  await fetch(API + "/freeze/" + index, {
    method: "POST",
    headers: { "Authorization": token }
  });

  loadChain();
}

// ------- Invalidate Block -------
async function invalidate(index) {
  await fetch(API + "/invalidate/" + index, {
    method: "POST",
    headers: { "Authorization": token }
  });

  loadChain();
}

// ------- Validate Chain -------
async function validate() {
  const res = await fetch(API + "/validate");
  const data = await res.json();

  document.getElementById("chainStatus").innerHTML =
    data.valid ? "‚úî Blockchain is Secure" : `‚ùå Tampered: ${data.issue}`;
}

// ------- Load Restore Requests -------
async function loadRequests() {
  const res = await fetch(API + "/restore/requests", {
    headers: { "Authorization": token }
  });

  const requests = await res.json();
  const box = document.getElementById("requests");
  box.innerHTML = "";

  requests.forEach(r => {
    box.innerHTML += `
      <div class="block">
        <span class="badge ${r.status}">${r.status.toUpperCase()}</span>
        <p><b>User:</b> ${r.user}</p>
        <p><b>Block:</b> ${r.blockIndex}</p>
        <p><b>Reason:</b> ${r.reason}</p>

        <button onclick="approve('${r._id}')">Approve</button>
        <button onclick="reject('${r._id}')">Reject</button>
      </div>`;
  });
}

// ------- Approve -------
async function approve(id) {
  await fetch(API + "/restore/approve/" + id, {
    method: "POST",
    headers: { "Authorization": token }
  });
  loadRequests();
}

// ------- Reject -------
async function reject(id) {
  await fetch(API + "/restore/reject/" + id, {
    method: "POST",
    headers: { "Authorization": token }
  });
  loadRequests();
}
</script>

</body>
</html>
