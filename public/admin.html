<!DOCTYPE html>
<html>
<head>
    <title>‚öñ Admin Panel - Evidence Blockchain</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #0d0d0d;
    color: #00eaff;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}

header {
    background: #001d26;
    padding: 12px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    border-bottom: 2px solid #00eaff;
}

button {
    background: #00eaff;
    border: none;
    padding: 8px 14px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}
button:hover {
    background: #00a6b3;
}

#chainBox, #requestsBox, #logBox {
    padding: 15px;
}

.block {
    border: 1px solid #00eaff;
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(0, 255, 255, 0.05);
    border-radius: 6px;
}

.hash {
    cursor: pointer;
    color: #ffdd57;
}
.hash:hover {
    text-decoration: underline;
}

.hidden {
    display: none;
}
</style>

</head>

<body onload="init()">

<header>‚öñ ADMIN EVIDENCE BLOCKCHAIN SYSTEM</header>

<div style="padding:12px; text-align:center;">
    <button onclick="loadChain()">üì¶ Blockchain</button>
    <button onclick="validateChain()">‚úî Validate</button>
    <button onclick="loadRequests()">üì© Restore Requests</button>
    <button onclick="loadLogs()">üìú Logs</button>
    <button onclick="logout()" style="background:#ff4444;color:white;">üö™ Logout</button>
</div>

<hr style="border-color:#00eaff;">

<div id="mainContent">
    <h3 style="padding-left:12px;">üì¶ Blockchain Records</h3>
    <div id="chainBox">Loading...</div>
</div>

<script>
const API = location.origin;
let token = localStorage.getItem("token");
if(!token) location.href = "/login.html";

// üîπ Show Chain
async function loadChain() {
    showMessage("Loading blockchain...");

    let res = await fetch(API + "/chain/admin", {
        headers: { "Authorization": token }
    });

    let data = await res.json();
    const box = document.getElementById("chainBox");
    box.innerHTML = "";

    if (!data.length) return box.innerHTML = "<p>No Records Found.</p>";

    data.forEach(b => {
        box.innerHTML += `
        <div class="block">
            <b>Block #${b.index}</b> | Status: ${b.status.toUpperCase()}<br>
            <b>Text:</b> ${b.text}<br>
            <b>Image Hash:</b> <span class="hash" onclick="viewImage('${b.imageId}')">${b.imageHash || "No Image"}</span><br>
            <b>Block Hash:</b> ${b.hash}<br>
            <b>Prev Hash:</b> ${b.previousHash}<br><br>

            <button onclick="freeze(${b.index})">Freeze</button>
            <button onclick="invalidate(${b.index})" style="background:#ff5757;">Invalidate</button>
        </div>`;
    });
}

// üîπ Freeze
async function freeze(i) {
    await fetch(API + `/freeze/${i}`, {
        method: "POST",
        headers: { "Authorization": token }
    });
    loadChain();
}

// üîπ Invalidate
async function invalidate(i) {
    await fetch(API + `/invalidate/${i}`, {
        method: "POST",
        headers: { "Authorization": token }
    });
    loadChain();
}

// üîπ View Image
function viewImage(id) {
    if(!id || id === "null") return alert("No Image");

    let url = API + `/reveal/${id}`;
    window.open(url, "_blank");
}

// üîπ Validate
async function validateChain() {
    let res = await fetch(API + "/validate", { headers:{Authorization:token}});
    let result = await res.json();

    if(result.valid) alert("‚úì Blockchain Valid & Untampered");
    else alert("‚ùå Blockchain Issue: " + result.issue);
}

// üîπ Load Requests
async function loadRequests() {
    showMessage("Loading restore requests...");

    let res = await fetch(API + "/restore/requests", {
        headers: { Authorization: token }
    });

    let data = await res.json();
    const box = document.getElementById("chainBox");
    box.innerHTML = "";

    if (!data.length) return box.innerHTML = "<p>No requests.</p>";

    data.forEach(r => {
        box.innerHTML += `
        <div class="block">
            <b>${r.user}</b> requested restore of Block #${r.blockIndex}<br>
            Reason: ${r.reason}<br>
            Status: <b>${r.status}</b><br><br>

            <button onclick="approve('${r._id}')">Approve</button>
            <button onclick="reject('${r._id}')" style="background:#ff5757;">Reject</button>
        </div>`;
    });
}

// üîπ Approve
async function approve(id) {
    await fetch(API + `/restore/approve/${id}`, {
        method: "POST",
        headers: { Authorization: token }
    });
    alert("Restored!");
    loadRequests();
}

// üîπ Reject
async function reject(id) {
    await fetch(API + `/restore/reject/${id}`, {
        method: "POST",
        headers: { Authorization: token }
    });
    loadRequests();
}

// üîπ Logs
async function loadLogs() {
    showMessage("Loading logs...");

    let res = await fetch(API + "/logs", {
        headers: { Authorization: token }
    });

    let data = await res.json();
    const box = document.getElementById("chainBox");
    box.innerHTML = "";

    data.forEach(log => {
        box.innerHTML += `<div class="block">üßç ${log.username} ‚Äì ${log.action} at ${log.timestamp}</div>`;
    });
}

// Logout
async function logout() {
    await fetch(API + "/auth/logout", {
        method: "POST",
        headers: { Authorization: token }
    });

    localStorage.removeItem("token");
    location.href = "/login.html";
}

// message UI
function showMessage(msg){
    document.getElementById("chainBox").innerHTML = `<p style="color:yellow;">${msg}</p>`;
}

function init(){ loadChain(); }

</script>

</body>
</html>
